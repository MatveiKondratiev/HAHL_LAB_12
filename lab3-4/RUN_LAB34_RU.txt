Лаба 3–4: вертикальное и горизонтальное масштабирование

Зачем это делаем (простыми словами):
- nginx — это обратный прокси и балансировщик. Он принимает запросы и
  распределяет их по экземплярам сервиса.
- Ограничение ресурсов (CPU/RAM) — проверка, как сервис ведёт себя
  при малых ресурсах (вертикальное масштабирование).
- k6 — генерация нагрузки, чтобы увидеть графики и пределы сервиса.
- Горизонтальное масштабирование — запуск нескольких экземпляров сервиса.

Важно про Grafana:
- Чтобы дашборды не пропадали, используется volume grafana_data
  (он уже добавлен в docker-compose.low.yml и docker-compose.high.yml).
  Дашборды сохраняются между перезапусками контейнера.

Структура:
lab3-4/
  docker-compose.low.yml  (малые ресурсы)
  docker-compose.high.yml (больше ресурсов)
  nginx/nginx.conf
  prometheus/prometheus.yml
  k6/high_load.js
  k6/long_run.js

Важно:
- Сервис доступен через nginx: http://localhost:8080/health
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000 (admin / admin)

------------------------------------------------------------
1) Старт с низкими ресурсами (вертикальное масштабирование — минимум)

Запуск:
  docker-compose -f lab3-4/docker-compose.low.yml up -d --build

Проверка:
  curl -i http://localhost:8080/health
  Скриншот: ответ /health в терминале

Grafana (формулы панелей):
  RPS:
    sum(rate(http_requests_total[1m]))
  Avg latency (s):
    sum(rate(http_request_latency_seconds_sum[5m])) /
    sum(rate(http_request_latency_seconds_count[5m]))
  p95 latency (s):
    histogram_quantile(0.95, sum(rate(http_request_latency_seconds_bucket[5m])) by (le))
  Скриншот: дашборд с 2–3 панелями (RPS/avg/p95)

Нагрузка (цель 1600 RPS):
  k6 run lab3-4/k6/high_load.js
  Скриншот: итоговый вывод k6

Что фиксировать:
- RPS, latency, error rate
- Сколько RPS реально держит сервис
- Скриншоты графиков

------------------------------------------------------------
2) Увеличение ресурсов (вертикальное масштабирование)

Остановить низкие ресурсы:
  docker-compose -f lab3-4/docker-compose.low.yml down

Запустить с высокими ресурсами:
  docker-compose -f lab3-4/docker-compose.high.yml up -d --build

Снова нагрузка:
  k6 run lab3-4/k6/high_load.js
  Скриншот: графики после увеличения ресурсов

Сравнить графики и сделать вывод:
- Что изменилось при большем CPU/RAM
- Упирается в CPU или в память

Если нужно повторять масштабирование:
- Меняй значения cpus и mem_limit в docker-compose.high.yml
- Перезапускай контейнеры и снова запускай k6

------------------------------------------------------------
3) Горизонтальное масштабирование (несколько экземпляров)

Оставляем низкие ресурсы, но запускаем несколько копий сервиса:
  docker-compose -f lab3-4/docker-compose.low.yml up -d --build

Масштабирование:
  docker-compose -f lab3-4/docker-compose.low.yml up -d --scale app=2

Если нужно обновить балансировку:
  docker-compose -f lab3-4/docker-compose.low.yml restart nginx

Нагрузка:
  k6 run lab3-4/k6/high_load.js
  Скриншот: графики при 2 инстансах

Добавить больше экземпляров:
  docker-compose -f lab3-4/docker-compose.low.yml up -d --scale app=3
  docker-compose -f lab3-4/docker-compose.low.yml restart nginx

Снова нагрузка, сравнить графики.
  Скриншот: графики при 3+ инстансах

------------------------------------------------------------
4) Длинный тест + выключение экземпляров

Запуск 10 минут:
  k6 run lab3-4/k6/long_run.js
  Скриншот: старт длинного теста

Пока идёт тест:
- стартовать с 7 инстансов (это «точка», где 1600 RPS держится без ошибок):
  docker-compose -f lab3-4/docker-compose.low.yml up -d --scale app=7
  docker-compose -f lab3-4/docker-compose.low.yml restart nginx
- через 2–3 минуты снизить до 6:
  docker-compose -f lab3-4/docker-compose.low.yml up -d --scale app=6
  docker-compose -f lab3-4/docker-compose.low.yml restart nginx
- через 2–3 минуты снизить до 5:
  docker-compose -f lab3-4/docker-compose.low.yml up -d --scale app=5
  docker-compose -f lab3-4/docker-compose.low.yml restart nginx
- через 2–3 минуты вернуть 7:
  docker-compose -f lab3-4/docker-compose.low.yml up -d --scale app=7
  docker-compose -f lab3-4/docker-compose.low.yml restart nginx

Наблюдать графики (RPS/latency/ошибки).
  Скриншот: момент падения и восстановления

------------------------------------------------------------
5) Экономика (стоимость)

Сравнить стоимость:
- один мощный сервер (вертикально)
- несколько маленьких (горизонтально)
Источник: Selectel (или другой провайдер)
  Скриншот: страницы тарифов/калькулятора

------------------------------------------------------------
6) Остановка

  docker-compose -f lab3-4/docker-compose.low.yml down
  docker-compose -f lab3-4/docker-compose.high.yml down

------------------------------------------------------------
7) Что писать в отчёте (коротко)

- Какие лимиты были в low/high (cpu/ram)
- Какой максимум RPS удалось держать
- Почему сервис CPU‑bound или memory‑bound (по графикам)
- Сравнение вертикали и горизонтали
- Стоимость вариантов (табличка)

